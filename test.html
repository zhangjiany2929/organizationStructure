<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>jOrgChart异步加载</title>
    <link rel="stylesheet" href='jquery.jOrgChart.css'/>
    <script type='text/javascript' src='jquery.min.js'></script>
    <script type='text/javascript' src='jquery.jOrgChart.js'></script>
    <script type="text/javascript" src="genSjSect_new_2.js"></script>
    <script type="text/javascript" src="parseData.js"></script>
    <style>
        span {
            text-decoration: none;
            color: #fff;
            font-size: 12px;
        }


    </style>
</head>
<body>
<!--显示组织架构图-->
<div id='jOrgChart'></div>


<script type='text/javascript'>
    $(function () {
        //数据返回
        $.ajax({
            url: "test.json",
            type: 'POST',
            dataType: 'JSON',
            data: {action: 'org_select'},
            success: function (result) {
                $.prjData = result.data[0];
                $.jlSect = getSects($.prjData, [], 'jl');
                $.sgSect = getSects($.prjData, [], 'sg');
                var showlist = $("<ul id='org' style='display:none'></ul>");
                showall(result.data, showlist);
                $("#jOrgChart").append(showlist);
                $("#org").jOrgChart({
                    chartElement: '#jOrgChart',//指定在某个dom生成jorgchart
                    dragAndDrop: false //设置是否可拖动
                });
                var fullColSpan = $('.jOrgChart .node-cell')[0].colSpan; //获取整个表格的列数
                var sjSects = [
                    {
                        id: '200',
                        name: '设计标1'
                    },
                    {
                        id: '201',
                        name: '设计标2'
                    },
                    {
                        id: '202',
                        name: '设计标3'
                    },
                    {
                        id: '203',
                        name: '设计标4'
                    },
                    {
                        id: '204',
                        name: '设计标5'
                    }
                ];
//                debugger;
                genSjSect(sjSects, fullColSpan);
                $('.node').click(function () {
                    //debugger;
//                    $('.node').css('backgroundColor', '#35363B'); //全部颜色设置为默认，然后开始高亮指定节点
                    showRelItems(this);
                });
            }
        });

        $.ajax({
            url: "sjSect.json",
            type: 'POST',
            dataType: 'JSON',
            data: {action: 'org_select'},
            success: function (result) {
                $.otherData = result;
                $.otherSect = getOtherSects($.otherData, []);
            }
        });
    });

    function showall(menu_list, parent) {
        $.each(menu_list, function (index, val) {
            if (val.childrens.length > 0) {
                var li = $("<li></li>");
                li.append("<span data-id='" + val.id + "' data-type='" + val.type + "'>" + val.name + "</span>").append("<ul></ul>").appendTo(parent);
                //递归显示
                showall(val.childrens, $(li).children().eq(1));
            } else {
                $("<li></li>").append("<span data-id='" + val.id + "' data-type='" + val.type + "'>" + val.name + "</span>").appendTo(parent);
            }
        });
    }

    function showRelItems(node) {

        $('.node').removeClass('onShow');
        $(node).addClass('onShow');
//        debugger;
//        node.style.backgroundColor = '#FF0000';
        var itemType = node.firstChild.getAttribute('data-type');
        if (itemType == 'sg') {
            //选中施工标
            showSgRelItems(node);
        } else if (itemType == 'jl') {
            //选中监理标
            showJlRelItems(node);
        } else if (itemType == 'xm') {
            //选中整个项目
            $('.node').addClass('onShow');
        } else {
            //选中其他标
            showQtRelItems(node);
        }
    }

    function showQtRelItems(node) {
        //高亮展示其他标段相关标段
        var itemId = node.firstChild.getAttribute('data-id');
        var qtItem;
        var jlItem;
        var sgItems = [];
        for (var i in $.otherSect) {
            if ($.otherSect[i].id == itemId) qtItem = $.otherSect[i];
        }


        //找到并高亮其对应施工标
        for (var i in $.sgSect) {
            for (var j in $.sgSect[i].qtId) {
                if ($.sgSect[i].qtId[j] == qtItem.id) sgItems.push($.sgSect[i]);
            }
        }
        for (var i in sgItems) {
            showSgRelItems($('.node>span[data-id=' + sgItems[i].id + ']').parent()[0]);
        }
    }


    function showJlRelItems(node) {
        //高亮展示监理标段相关标段
        var itemId = node.firstChild.getAttribute('data-id');
        var jlItem;
        var sgItems = [];
        for (var i in $.jlSect) {
            if ($.jlSect[i].id == itemId) jlItem = $.jlSect[i];
        }


        //找到并高亮其对应施工标
        for (var i in $.sgSect) {
                if ($.sgSect[i].pid == jlItem.id) sgItems.push($.sgSect[i]);
        }
        for (var i in sgItems) {
            showSgRelItems($('.node>span[data-id=' + sgItems[i].id + ']').parent()[0]);
        }
    }


    function showSgRelItems(node) {
        //高亮展示施工标段相关标段
        $(node).addClass('onShow');
//        node.style.backgroundColor = '#FF0000';
        var itemId = node.firstChild.getAttribute('data-id');
        var sgItem;
        var jlItem;
        var qtItems = [];
        for (var i in $.sgSect) {
            if ($.sgSect[i].id == itemId) sgItem = $.sgSect[i];
        }

        //找到并高亮其监理标
        for (var i in $.jlSect) {
            if ($.jlSect[i].id == sgItem.pid) jlItem = $.jlSect[i];
        }
        $('.node>span[data-id=' + jlItem.id + ']').parent().addClass('onShow');
        //找到并高亮其对应其他标

        for (var i in $.otherSect) {
            for (var j in sgItem.qtId) {
                if ($.otherSect[i].id == sgItem.qtId[j]) qtItems.push($.otherSect[i]);
            }
        }
        for (var i in qtItems) {
            $('.node>span[data-id=' + qtItems[i].id + ']').parent().addClass('onShow');
        }
    }

    function findObjById(dataId) {
        var item = {
            "id": dataId,

        };
        return item;
    }
</script>
</body>
</html>